name: Terraform AWS Lambda

on:
  push:
    branches:
      - master

jobs:
  terraform:
    name: Terraform
    runs-on: ubuntu-latest
    stages:
      - init:
          steps:
            - name: Checkout Repository
              uses: actions/checkout@v2
            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v1
              with:
                aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                aws-region: ap-northeast-1
            - name: Terraform Init
              run: terraform init

      - plan:
          steps:
            - name: Terraform Plan
              run: terraform plan

      - apply:
          steps:
            - name: Terraform Apply
              run: terraform apply -auto-approve

      - destroy:
          steps:
            - name: Terraform Destroy
              run: terraform destroy -auto-approve
              depends_on:
                - plan
